<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>福祉タクシー利用料</title>
  <style>
    /* 全体をUD明朝に */
    body {
      font-family: "UD明朝", serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }
    /* フォーム部品やボタンにもUD明朝を継承 */
    input, select, button, textarea {
      font-family: inherit;
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      box-sizing: border-box;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    .radio-group, .checkbox-group {
      margin-bottom: 15px;
    }
    .radio-group label, .checkbox-group label {
      font-weight: normal;
      margin-left: 20px;
      display: inline-block;
    }
    #result, #details, #breakdown {
      margin-top: 20px;
      font-weight: bold;
    }
    #breakdown ul {
      padding-left: 20px;
    }

    /* 請求書・領収書出力用 */
    #invoice {
      display: none;
    }
    .invoice-block {
      border: 1px solid #000;
      padding: 10px;
      margin-bottom: 20px;
      /* 各ブロックを別ページに分ける */
      page-break-after: always;
    }
    /* 最終ブロックはページ区切り不要 */
    .invoice-block:last-child {
      page-break-after: auto;
    }
    .invoice-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .invoice-title {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 10px;
    }
    .invoice-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-family: inherit;
    }
    .invoice-table th, .invoice-table td {
      border: 1px solid #000;
      padding: 2px;
      line-height: 1.2;
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD1Y1geobXRlk517MSj_b3dEl9o1wZjKSs&libraries=places" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
</head>
<body>
  <h3>福祉タクシー 利用料計算</h3>

  <!-- 入力フォーム省略（省スペースのため省略しています） -->

  <button id="calcBtn">運賃を計算する</button>
  <div id="result"></div>
  <div id="details"></div>
  <div id="breakdown"></div>
  <button id="pdfBtn">PDFを出力する</button>

  <div id="invoice">
    <!-- 請求書 -->
    <div class="invoice-block">
      <div class="invoice-title">福祉タクシー利用料（請求書）</div>
      <div class="invoice-header">
        <div>宛名：__________________________</div>
        <div>発行日：________年____月____日</div>
      </div>
      <div>車種：<span id="invoiceVehicle"></span></div>
      <table class="invoice-table" id="invoice-table"></table>
      <div style="margin-top: 10px; text-align: right;">発行元：一般社団法人NURTURES みみの家</div>
    </div>
    <!-- 領収書 -->
    <div class="invoice-block">
      <div class="invoice-title">福祉タクシー利用料（領収書）</div>
      <div class="invoice-header">
        <div>宛名：__________________________</div>
        <div>発行日：________年____月____日</div>
      </div>
      <div>車種：<span id="invoiceVehicleCopy"></span></div>
      <table class="invoice-table" id="invoice-table-copy"></table>
      <div style="margin-top: 10px; text-align: right;">発行元：一般社団法人NURTURES みみの家</div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('calcBtn').addEventListener('click', calculateFare);
      document.getElementById('pdfBtn').addEventListener('click', generatePDF);
    });

    let distanceKmGlobal = 0;

    function calculateFare() {
      // ここに運賃計算ロジック（元のコードから変更なし）
      // 例: distanceKmGlobal に値、 #result,#details,#breakdown に出力
    }

    function generatePDF() {
      const breakdownEl = document.getElementById('breakdown');
      if (!breakdownEl.innerHTML) {
        alert('先に計算してください');
        return;
      }
      const vehicleType = document.getElementById('vehicleType').value;
      document.getElementById('invoiceVehicle').textContent = vehicleType;
      document.getElementById('invoiceVehicleCopy').textContent = vehicleType;

      // 明細をテーブルに変換
      const items = Array.from(breakdownEl.querySelectorAll('li'))
        .map(li => `<tr><td>${li.textContent}</td></tr>`).join('');
      const extra =
        `<tr><td><strong>合計運賃：</strong>${document.getElementById('result').textContent}</td></tr>` +
        `<tr><td><strong>走行距離：</strong>${distanceKmGlobal.toFixed(2)} km</td></tr>`;
      const tableHTML = `<tr><th>明細</th></tr>${items}${extra}`;

      document.getElementById('invoice-table').innerHTML = tableHTML;
      document.getElementById('invoice-table-copy').innerHTML = tableHTML;

      // PDF生成（A4、マージン10mm、2ページにまたがる）
      const inv = document.getElementById('invoice');
      inv.style.display = 'block';
      html2pdf()
        .from(inv)
        .set({ margin: 10, filename: '請求書_領収書.pdf', jsPDF: { unit: 'mm', format: 'a4' } })
        .save()
        .then(() => { inv.style.display = 'none'; });
    }
  </script>
</body>
</html>
