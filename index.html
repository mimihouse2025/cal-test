<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>福祉タクシー利用料</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    input, select, button { width: 100%; padding: 8px; margin: 10px 0; box-sizing: border-box; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    #result, #breakdown { margin-top: 20px; font-weight: bold; }
    #breakdown ul { padding-left: 20px; }
    /* PDF用領域は普段は非表示 */
    #invoice { display: none; background: #fff; padding: 10px; }
    .invoice-block { border: 1px solid #000; padding: 10px; margin-bottom: 20px; }
    .invoice-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .invoice-title { text-align: center; font-size: 18px; margin-bottom: 10px; }
    .invoice-table { width: 100%; border-collapse: collapse; }
    .invoice-table td { border: 1px solid #000; padding: 4px; }
  </style>
  <!-- 必ずこの順で読み込んでください -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD1Y1geobXRlk517MSj_b3dEl9o1wZjKSs&libraries=places">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
  <h3>福祉タクシー 利用料計算</h3>
  <input id="origin" placeholder="出発地" />
  <input id="destination" placeholder="目的地" />
  <label>時刻：<input type="time" id="rideTime" value="10:00"></label>
  <label>車種：
    <select id="vehicleType">
      <option value="軽自動車">軽自動車</option>
      <option value="大型ワンボックス">ワンボックス型</option>
    </select>
  </label>
  <div>
    <label>看護師（人）<input id="nurseAssistants" type="number" min="0" value="0"></label>
    <label>ヘルパー（人）<input id="helperAssistants" type="number" min="0" value="0"></label>
    <label>付き添い時間（h）<input id="assistantHours" type="number" step="0.5" value="0"></label>
    <label>階段介助：
      <select id="stairsSupport">
        <option value="no" selected>なし</option>
        <option value="yes">あり</option>
      </select>
    </label>
    <label>車椅子持込：<input id="ownWheelchair" type="checkbox"></label>
  </div>

  <button id="calcBtn">運賃を計算する</button>
  <div id="result"></div>
  <div id="breakdown"></div>

  <button id="pdfBtn">PDFを出力する</button>

  <!-- PDF出力用 -->
  <div id="invoice">
    <div class="invoice-block">
      <div class="invoice-title">請求書</div>
      <div class="invoice-header">
        <div>宛名：________</div>
        <div>発行日：____年__月__日</div>
      </div>
      <div>車種：<span id="invoiceVehicle"></span></div>
      <table class="invoice-table" id="invoice-table"></table>
    </div>
    <div class="invoice-block">
      <div class="invoice-title">領収書</div>
      <div class="invoice-header">
        <div>宛名：________</div>
        <div>発行日：____年__月__日</div>
      </div>
      <div>車種：<span id="invoiceVehicleCopy"></span></div>
      <table class="invoice-table" id="invoice-table-copy"></table>
    </div>
  </div>

  <script>
    document.getElementById('calcBtn').onclick = calculateFare;
    document.getElementById('pdfBtn').onclick  = generatePDF;

    function calculateFare() {
      if (!google?.maps?.DirectionsService) {
        return alert('Google Maps APIエラー');
      }
      const o = document.getElementById('origin').value.trim();
      const d = document.getElementById('destination').value.trim();
      if (!o||!d) return alert('出発地・目的地を入力してください');
      const h = +document.getElementById('rideTime').value.split(':')[0];
      const isNight = h>=22 || h<5;
      const vt = document.getElementById('vehicleType').value;
      const own = document.getElementById('ownWheelchair').checked;
      if (vt==='軽自動車' && own) {
        return alert('軽自動車では車椅子持込不可');
      }
      const nurse = +document.getElementById('nurseAssistants').value;
      const helper= +document.getElementById('helperAssistants').value;
      const time  = +document.getElementById('assistantHours').value;
      if ((nurse+helper)>0 && time===0) {
        return alert('付添いがある場合は時間を入力');
      }
      new google.maps.DirectionsService().route({
        origin:o,destination:d,travelMode:'DRIVING'
      }, (res,status)=>{
        if(status!=='OK') return alert('ルート取得失敗');
        const km = res.routes[0].legs[0].distance.value/1000;
        let fare = 341;
        const bd = [`基本運賃¥341`];
        if(km>1){
          const ex = Math.ceil(km-1)*330;
          fare+=ex; bd.push(`追加距離¥${ex}`);
        }
        if(isNight){ fare=Math.round(fare*1.2); bd.push('深夜割増×1.2'); }
        fare+=400; bd.push('予約料¥400');
        if(nurse+helper>0){
          let unit = nurse*3000+helper*1250;
          let sub = unit*(time*2);
          if(isNight) sub=Math.round(sub*1.2);
          fare+=sub; bd.push(`付添い¥${sub}`); bd.push(`時間${time*60}分`);
        }
        if(document.getElementById('stairsSupport').value==='yes'){
          if(nurse+helper===0) return alert('階段介助に付添い必須');
          fare+=1600; bd.push('階段介助¥1600');
        }
        if(own) bd.push('車椅子持込');
        document.getElementById('result').textContent = `合計：¥${fare.toLocaleString()}`;
        document.getElementById('breakdown').innerHTML = '<ul><li>'+bd.join('</li><li>')+'</li></ul>';
      });
    }

    function generatePDF() {
      if (!window.html2pdf) return alert('PDFライブラリが見つかりません');
      // 請求書／領収書を表示
      const inv = document.getElementById('invoice');
      inv.style.display = 'block';
      // 車種セット
      const vt = document.getElementById('vehicleType').value;
      document.getElementById('invoiceVehicle').textContent     = vt;
      document.getElementById('invoiceVehicleCopy').textContent = vt;
      // 内訳コピー
      const src = document.querySelectorAll('#breakdown li');
      const tbl = document.getElementById('invoice-table');
      const tbc = document.getElementById('invoice-table-copy');
      tbl.innerHTML = tbc.innerHTML = '';
      src.forEach(li=>{
        const tr=document.createElement('tr');
        const td=document.createElement('td');
        td.textContent = li.textContent;
        tr.appendChild(td);
        tbl.appendChild(tr);
        tbc.appendChild(tr.cloneNode(true));
      });
      // PDF出力
      html2pdf().from(inv).set({
        margin:0.5,
        filename:'福祉タクシー請求書.pdf',
        html2canvas:{scale:2},
        jsPDF:{unit:'in',format:'a4'}
      }).save().then(()=>{
        inv.style.display='none';
      });
    }
  </script>
</body>
</html>
